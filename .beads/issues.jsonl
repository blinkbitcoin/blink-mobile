{"id":"blink-mobile-3pa","title":"Review and test Sumsub KYC WebView fix","description":"## Context\n\nInvestigation complete (see blink-mobile-dyw). The fix has been implemented - InAppBrowser replaced with native WebView in `full-onboarding-flow.tsx`.\n\n## Task\n\nReview and test the WebView implementation to ensure:\n\n1. **Camera capture** works on Android (primary KYC flow)\n2. **File upload** works on Android (secondary flow)\n3. **Camera permissions** are properly granted via WebView's `onPermissionRequest`\n4. **No regressions** on iOS\n\n## Test Devices\n\nPriority devices to test:\n- Samsung Galaxy A36 / Android 16 (upload crash was reported here)\n- GrapheneOS device (camera permission issue was reported here)\n- Standard Android device\n- iOS device\n\n## References\n\n- Investigation: `docs/research/sumsub-android-webview-issues.md`\n- Changed file: `app/screens/full-onboarding-flow/full-onboarding-flow.tsx`\n- Related issue: blink-mobile-dyw (closed)","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-15T18:06:23.560029+07:00","updated_at":"2025-12-15T18:06:23.560029+07:00"}
{"id":"blink-mobile-dyw","title":"Fix Sumsub KYC Android WebView Issues (Upload Crash + Camera Permission)","description":"## Executive Summary\n\nFollowing the migration from Onfido to Sumsub for KYC verification, two issues were reported on Android devices related to the in-app browser implementation.\n\n## Problem Statement\n\n### Issue 1: Document Upload Crash\n\n**Reporter:** Sumsub Solution Architect\n**Device:** Samsung Galaxy A36, One UI 8.0, Android 16\n**Symptom:** App crashes when attempting to upload a document during KYC verification.\n\n### Issue 2: Camera Permission Failure\n\n**Reporter:** Oms\n**Device:** GrapheneOS (privacy-focused Android ROM)\n**Symptom:** During the selfie step, the user granted camera permission when prompted, but the web page still failed to access the camera.\n\n**Important Finding:** Camera capture (taking a photo directly) works correctly on both devices. The issues are specific to:\n- File upload functionality (Issue 1)\n- Permission flow on hardened Android variants (Issue 2)\n\n## Technical Context\n\nThe blink-mobile app uses `react-native-inappbrowser-reborn` to open the Sumsub KYC flow, which uses **Chrome Custom Tabs** on Android - fundamentally different from a native WebView.\n\n| Capability | Chrome Custom Tabs | Native WebView |\n|------------|-------------------|----------------|\n| Camera permission handling | Delegated to Chrome browser | App can override `onPermissionRequest` |\n| File upload | Uses Chrome's file picker | App can customize with `onShowFileChooser` |\n| getUserMedia API | Requires Chrome's site permission | Can be granted programmatically |\n| Activity lifecycle | Separate Chrome activity | Embedded in app activity |\n\n## Root Cause Analysis\n\n### Issue 1: Document Upload Crash\n\n**Root Cause:** Chrome Custom Tabs activity destruction during file selection.\n\nWhen the user initiates a file upload:\n1. Chrome Custom Tabs launches the Android file picker\n2. Android may destroy the Chrome Custom Tabs activity to free memory\n3. When the file picker returns, the original activity context is gone\n4. InAppBrowser receives a \"cancel\" result\n5. The internal browser closes unexpectedly, perceived as a crash\n\n**Contributing Factors:**\n- Android 14/15/16 have a documented bug ([Google Issue Tracker #317289301](https://issuetracker.google.com/issues/317289301))\n- Samsung's One UI memory management may be more aggressive\n- The `react-native-inappbrowser-reborn` library doesn't handle activity recreation gracefully\n\n### Issue 2: Camera Permission Failure\n\n**Root Cause:** Two-layer permission model in Chrome Custom Tabs.\n\nCamera access requires TWO separate permissions:\n- Layer 1: Android OS Permission (granted to Blink app ✓)\n- Layer 2: Chrome Site Permission (controlled by Chrome's internal permission system ✗)\n\n**This issue is NOT GrapheneOS-specific** - it can occur on any Android device where Chrome hasn't granted camera permission to the KYC domain.\n\n## Solutions\n\n### Solution A: Staged Approach (Mitigations Now, Full Fix Later)\n\n**Phase 1: Ship with Mitigations**\n- Upload Crash: Accept limitation; camera capture works correctly\n- Camera Permission: Implement `onError` handler in blink-kyc to show troubleshooting guidance\n\n**Pros:** Fast deployment, minimal changes, no app store release needed\n**Cons:** Degraded UX for edge cases, ongoing support burden\n\n**Phase 2:** Implement full fix (Solution B)\n\n### Solution B: Full Fix (WebView or Native SDK)\n\n**Option B1: Native WebView** - Replace InAppBrowser with `react-native-webview`, add version detection for backward compatibility\n\n**Option B2: Sumsub Native SDK** - Best UX, all permission/file handling managed by Sumsub, but more implementation effort\n\n## Comparison\n\n| Criteria | Solution A (Staged) | Solution B (Full Fix) |\n|----------|--------------------|-----------------------|\n| Time to deploy | Fast (days) | Slower (weeks) |\n| Development effort | Low | Medium |\n| User experience | Acceptable with known limitations | Optimal |\n| Risk of user drop-off | Low-Medium | Minimal |\n\n## References\n\n- Full analysis: `docs/research/sumsub-android-webview-issues.md`\n- [Sumsub WebSDK Messages](https://docs.sumsub.com/docs/websdk-messages)\n- [Sumsub Android SDK](https://docs.sumsub.com/docs/changelog-android)\n- Code: `app/screens/full-onboarding-flow/full-onboarding-flow.tsx`","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-15T18:04:27.558004+07:00","updated_at":"2025-12-15T18:06:23.376643+07:00","closed_at":"2025-12-15T18:06:23.376643+07:00","close_reason":"Investigation complete. Root cause identified and solutions documented in docs/research/sumsub-android-webview-issues.md"}
